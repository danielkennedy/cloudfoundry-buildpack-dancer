#!/usr/bin/env bash
# usage: bin/compile <build-dir> <cache-dir>
BUILD=$(cd "$1/" && pwd)
CACHE=$(cd "$2/" && pwd)

# Our list of downloads
declare -a DOWNLOADS=( $CACHE/perl-5.18.2.tar.gz dancer? yaml?)

# Our list of eventually necessary dependency files
declare -a EXECUTABLES=( perl dancer.pm yaml.pm )

for i in $CACHE $CACHE/perl $CACHE/perl/buildback
do
  if [ ! -d $i ]
  then
    mkdir -p $CACHE
  fi
done
if [ ! -f $CACHE/perl-5.18.2.tar.gz ]
then
  curl -O --progress-bar http://www.cpan.org/src/5.0/
fi
if [ ! -x $CACHE/perl/Configure ]
then
  cd $CACHE && tar -C $CACHE/perl -zxf perl-5.18.2.tar.gz --strip-components=1
fi
if [ ! -d $CACHE/perl/.config ]
then
  cd $CACHE/perl && ./Configure -des -Dprefix=$CACHE/perl/buildpack
fi
if [ ! -d $CACHE/perl/buildpack/bin ] || [ ! -x $CACHE/perl/buildpack/bin/perl ]
then
  cd $CACHE/perl && make install
fi
### At this point, perl and all of its libs are found in $CACHE/perl/buildpack
cd $CACHE/perl/buildpack
export PATH=$CACHE/perl/buildback/bin:$PATH
curl -L http://cpanmin.us | perl - Dancer
### At this point dancer (25 modules, really) are *somewhere*

