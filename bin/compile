#!/usr/bin/env bash
# usage: bin/compile <build-dir> <cache-dir>
BUILD=$1
CACHE=$2

# Our list of downloads
declare -a DOWNLOADS=( $CACHE/perl-5.18.2.tar.gz )

# Our list of eventually necessary dependency files
declare -a DEPENDENCIES=( $CACHE/perl/buildpack/bin/perl dancer.pm yaml.pm )

for i in $CACHE $CACHE/perl $CACHE/perl/buildpack
do
  if [ ! -d $i ]
  then
    echo "Making directory: $i"
    mkdir -p $i
  fi
done

### Download perl tarball, if necessary
if [ ! -f $CACHE/perl-5.18.2.tar.gz ]
then
  cd $CACHE && curl -O --progress-bar http://www.cpan.org/src/5.0/perl-5.18.2.tar.gz
fi

### Unpack perl tarball, if necessary
if [ ! -x $CACHE/perl/Configure ]
then
  cd $CACHE && tar -C $CACHE/perl -zxf perl-5.18.2.tar.gz --strip-components=1
fi

### Prepare perl for building, if necessary
if [ ! -d $CACHE/perl/.config ]
then
  cd $CACHE/perl && ./Configure -des -Dprefix=$CACHE/perl/buildpack
fi

### Build and install perl, if necessary
if [ ! -d $CACHE/perl/buildpack/bin ] || [ ! -x $CACHE/perl/buildpack/bin/perl ]
then
  cd $CACHE/perl && make install
fi

### Verify whether perl is functional
export PATH=$CACHE/perl/buildpack/bin:$PATH
[ $(which perl) = $CACHE/perl/buildpack/bin/perl ] || exit 1
[ $(perl -e 'print "yes"') = "yes" ] || exit 1

### Install Dancer, if necessary
if [ ! -d $CACHE/perl/buildpack/lib/site_perl/5.18.2/Dancer ]
then
  export PERL5LIB=$CACHE/perl/buildpack/lib/site_perl/5.18.2
  cd $CACHE/perl/buildpack &&curl -L http://cpanmin.us | perl - Dancer
fi

### Install YAML, if necessary
if [ ! -d $CACHE/perl/buildpack/lib/site_perl/5.18.2/YAML ]
then
  export PERL5LIB=$CACHE/perl/buildpack/lib/site_perl/5.18.2
  cd $CACHE/perl/buildpack &&curl -L http://cpanmin.us | perl - YAML
fi

### Setup the build directory as needed
# The app, located in $BUILD, needs to be able to resolve its dependencies for perl and dancer. How do I do that?
mkdir -p $BUILD/.profile.d
echo 'export PATH='$PATH > $BUILD/.profile.d/dancer.sh
